<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp" xmlns:smtp="http://www.mulesoft.org/schema/mule/smtp" xmlns:s3="http://www.mulesoft.org/schema/mule/s3" xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
http://www.mulesoft.org/schema/mule/s3 http://www.mulesoft.org/schema/mule/s3/current/mule-s3.xsd
http://www.mulesoft.org/schema/mule/smtp http://www.mulesoft.org/schema/mule/smtp/current/mule-smtp.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd">
    <flow name="VFC:TNF:run-api-updates-from-database">
        <flow-ref name="VFC:TNF:ingest-plu-settings" doc:name="VFC:TNF:ingest-plu-settings"/>
        <flow-ref name="MI:OAuth:retrieveToken" doc:name="MI:OAuth:retrieveToken"/>
        <component doc:name="Database to Catalog Update">
            <singleton-object class="vfcorp.PLUApiUpdatesCallable">
            	<property key="databaseUrl" value="jdbc:mysql://${mysql.ip}:${mysql.port}/${mysql.database}"/>
            	<property key="databaseUser" value="${mysql.user}"/>
            	<property key="databasePassword" value="${mysql.password}"/>
            	<property key="itemNumberLookupLength" value="${vfcorp.itemNumberLookupLength}"/>
            </singleton-object>
        </component>
        <set-payload value="Completed api updates: #[flowVars.pluFilename]" doc:name="Set Payload"/>
        <smtp:outbound-endpoint host="smtp.gmail.com" port="587" user="${email.info.sending.email}" password="${email.info.sending.password}" connector-ref="Gmail" to="${email.info.receiving.email}" from="Square Bridge" subject="#['${mule.env}'.toUpperCase() + ' - COMPLETED catalog api updates - ' + flowVars.deployment]" responseTimeout="10000" doc:name="Email to Sales Eng"/>
    </flow>
    <sub-flow name="VFC:TNF:ingest-plu-to-database">
        <logger message="Initiating PLU (#[message.inboundProperties.originalFilename]) ingestion for deployment #[flowVars.deployment] -- with database updates" level="INFO" doc:name="Logger"/>
        <set-variable variableName="pluFilename" value="#[message.inboundProperties.originalFilename]" doc:name="Save pluFilename"/>
        <set-variable variableName="pluStreamReaderAWS" value="#[payload]" doc:name="Save PLU stream reader"/>
        <set-payload value="Started: #[flowVars.pluFilename]" doc:name="email payload"/>
        <smtp:outbound-endpoint host="smtp.gmail.com" port="587" user="${email.info.sending.email}" password="${email.info.sending.password}" connector-ref="Gmail" to="${email.info.receiving.email}" from="Square Bridge" subject="#['${mule.env}'.toUpperCase() + ' - STARTED catalog (db) - ' + flowVars.deployment]" responseTimeout="10000" doc:name="Email to Sales Eng"/>
        <flow-ref name="GLOBAL:set-session-vars" doc:name="GLOBAL:set-session-vars"/>
        <logger message="Saving file to S3..." level="INFO" doc:name="Logger"/>
        <s3:create-object config-ref="Amazon_S3__Configuration" bucketName="${aws.bucket}" key="#[flowVars.awsFolder + flowVars.pluFilename]" content-ref="#[flowVars.pluStreamReaderAWS]" doc:name="Copy to Amazon S3"/>
        <logger message="File saved to S3. Establishing new input stream from S3..." level="INFO" doc:name="Logger"/>
        <s3:get-object config-ref="Amazon_S3__Configuration" bucketName="${aws.bucket}" key="#[flowVars.awsFolder + flowVars.pluFilename]" doc:name="Read new stream from S3"/>
        <set-variable variableName="pluInputStream" value="#[payload.objectContent]" doc:name="Save PLU stream reader"/>
        <logger message="Retrieved new inputStream from S3. Beginning syncing to database..." level="INFO" doc:name="Logger"/>
        <flow-ref name="MI:OAuth:retrieveToken" doc:name="MI:OAuth:retrieveToken"/>
        <set-variable variableName="merchantId" value="#[payload.getMerchantId()]" doc:name="merchantId"/>
        <set-variable variableName="locationId" value="#[payload.getLocationId()]" doc:name="locationId"/>
        <component doc:name="Sync PLU To Database">
            <singleton-object class="vfcorp.PLUSyncDBCallable">
            	<property key="databaseUrl" value="jdbc:mysql://${mysql.ip}:${mysql.port}/${mysql.database}"/>
            	<property key="databaseUser" value="${mysql.user}"/>
            	<property key="databasePassword" value="${mysql.password}"/>
            </singleton-object>
        </component>
        <set-payload value="Completed database sync: #[flowVars.pluFilename]" doc:name="Set Payload"/>
        <smtp:outbound-endpoint host="smtp.gmail.com" port="587" user="${email.info.sending.email}" password="${email.info.sending.password}" connector-ref="Gmail" to="${email.info.receiving.email}" from="Square Bridge" subject="#['${mule.env}'.toUpperCase() + ' - COMPLETED catalog db sync - ' + flowVars.deployment]" responseTimeout="10000" doc:name="Email to Sales Eng"/>
    </sub-flow>
    <flow name="VFC:TNF:plu-store-99999" processingStrategy="synchronous">
        <sftp:inbound-endpoint connector-ref="VFCorpSFTP" host="${vfcorp.sftp.host}" port="${vfcorp.sftp.port}" path="${vfcorp.sftp.path.tnf}${vfcorp.sftp.path.tnf.rpc.store99999}" user="${vfcorp.sftp.username}" password="${vfcorp.sftp.password}" responseTimeout="${vfcorp.sftp.timeout}" pollingFrequency="${vfcorp.sftp.pollingFrequency}" tempDir="processing" useTempFileTimestampSuffix="true" doc:name="SFTP"/>
        <set-variable variableName="storeId" value="99999" doc:name="Set storeId: 99999"/>
        <set-variable variableName="timeZone" value="America/Los_Angeles" doc:name="Set timeZone: America/Los_Angeles"/>
        <flow-ref name="VFC:TNF:ingest-plu-settings" doc:name="VFC:TNF:ingest-plu-settings"/>
        <flow-ref name="VFC:TNF:ingest-plu-to-database" doc:name="VFC:TNF:ingest-plu-to-database"/>
        <flow-ref name="VFC:TNF:run-api-updates-from-database" doc:name="VFC:TNF:run-api-updates-from-database"/>
    </flow>
</mule>
