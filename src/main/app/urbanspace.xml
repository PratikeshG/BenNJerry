<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ssl="http://www.mulesoft.org/schema/mule/ssl" xmlns:smtps="http://www.mulesoft.org/schema/mule/smtps" xmlns:schedulers="http://www.mulesoft.org/schema/mule/schedulers" xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting" xmlns:quartz="http://www.mulesoft.org/schema/mule/quartz" xmlns:smtp="http://www.mulesoft.org/schema/mule/smtp"
	xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw" xmlns:metadata="http://www.mulesoft.org/schema/mule/metadata" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:vm="http://www.mulesoft.org/schema/mule/vm" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/smtp http://www.mulesoft.org/schema/mule/smtp/current/mule-smtp.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/vm http://www.mulesoft.org/schema/mule/vm/current/mule-vm.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.mulesoft.org/schema/mule/quartz http://www.mulesoft.org/schema/mule/quartz/current/mule-quartz.xsd
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
http://www.mulesoft.org/schema/mule/schedulers http://www.mulesoft.org/schema/mule/schedulers/current/mule-schedulers.xsd
http://www.mulesoft.org/schema/mule/smtps http://www.mulesoft.org/schema/mule/smtps/current/mule-smtps.xsd
http://www.mulesoft.org/schema/mule/ssl http://www.mulesoft.org/schema/mule/ssl/current/mule-ssl.xsd">
    <queued-asynchronous-processing-strategy name="Urbanspace_Report_Async_Processing_Strategy" maxThreads="${urbanspace.maxThreads}" minThreads="1" doc:name="Queued Asynchronous Processing Strategy" poolExhaustedAction="WAIT" threadWaitTimeout="1800000"></queued-asynchronous-processing-strategy>
    <vm:connector name="Urbanspace_VM_Config" validateConnections="true" doc:name="VM"/>
    <quartz:connector name="Quartz-Urbanspace" validateConnections="true" doc:name="Quartz">
        <quartz:factory-property key="org.quartz.scheduler.instanceName" value="Quartz-Urbanspace"/>
    </quartz:connector>
    <flow name="Urbanspace:generate-individual-and-aggregate-reports">
        <logger message="Starting Urbanspace:generate-individual-and-aggregate-reports (#[flowVars.deployment])" level="INFO" doc:name="Logger"/>
        <flow-ref name="GLOBAL:set-session-vars" doc:name="GLOBAL:set-session-vars"/>
        <flow-ref name="MI:OAuth:retrieve-tokens" doc:name="MI:OAuth:retrieve-tokens"/>
        <component doc:name="Configure deployment payloads">
            <prototype-object class="urbanspace.ReportGeneratorPayloadCallable"/>
        </component>
        <request-reply doc:name="Request-Reply">
            <vm:outbound-endpoint exchange-pattern="one-way" path="Urbanspace:generate-individual-and-aggregate-reports-async-worker" connector-ref="Urbanspace_VM_Config" doc:name="VM">
                <collection-splitter doc:name="Collection Splitter" enableCorrelation="ALWAYS"/>
            </vm:outbound-endpoint>
            <vm:inbound-endpoint exchange-pattern="one-way" path="Urbanspace:generate-individual-and-aggregate-reports-reply" connector-ref="Urbanspace_VM_Config" doc:name="VM">
                <collection-aggregator failOnTimeout="true" doc:name="Collection Aggregator"/>
            </vm:inbound-endpoint>
        </request-reply>
        <component doc:name="Calculate UrbanSpace Aggregate Totals">
            <prototype-object class="urbanspace.ReportGenerator"/>
       </component>
       <set-payload value="Attached." doc:name="Set Payload"/>
       <smtp:outbound-endpoint host="${email.info.sending.server}"  user="${email.info.sending.username}" password="${email.info.sending.password}" connector-ref="SES_SMTP_STARTTLS"  from="${email.info.sending.from.reports}" subject="#[('${mule.env}'.equals(&quot;production&quot;) ? '' : '${mule.env}'.toUpperCase() + ' - ') + sessionVars.deploymentName + ' - Daily Aggregate Report']" responseTimeout="10000" doc:name="Email results" to="#[sessionVars.emails]"/>
    </flow>
    <flow name="Urbanspace:generate-individual-and-aggregate-reports-async-worker" processingStrategy="Urbanspace_Report_Async_Processing_Strategy">
        <vm:inbound-endpoint exchange-pattern="one-way" path="Urbanspace:generate-individual-and-aggregate-reports-async-worker" connector-ref="Urbanspace_VM_Config" doc:name="Worker VM"/>
        <component doc:name="Get payments, refunds, categories, discounts for location">
            <prototype-object class="urbanspace.IndividualLocationRequestsCallable"/>
        </component>
    </flow>
    <flow name="Urbanspace:trigger-reports" processingStrategy="synchronous">
        <http:listener config-ref="${default.http.config}" path="/urbanspace/reports/${urlKey}" allowedMethods="GET" doc:name="/urbanspace/reports"/>
        <logger message="#['Starting UrbanSpace: ' + message.inboundProperties.'http.query.params'.deployment]" level="INFO" doc:name="Logger"/>
        <set-variable variableName="deployment" value="#[message.inboundProperties.'http.query.params'.deployment]" doc:name="Deployment ID"/>
        <set-session-variable variableName="deploymentName" value="#[message.inboundProperties.'http.query.params'.deploymentName]" doc:name="Deployment Name"/>
        <set-session-variable variableName="range" value="#[new java.lang.Integer(message.inboundProperties.'http.query.params'.range)]" doc:name="Time range"/>
        <set-session-variable variableName="offset" value="#[new java.lang.Integer(message.inboundProperties.'http.query.params'.offset)]" doc:name="Time offset"/>
        <set-session-variable variableName="timeZone" value="#[message.inboundProperties.'http.query.params'.timeZone]" doc:name="Timezone"/>
        <set-session-variable variableName="emails" value="#[message.inboundProperties.'http.query.params'.emails]" doc:name="Emails"/>
        <flow-ref name="Urbanspace:generate-individual-and-aggregate-reports" doc:name="Urbanspace:generate-individual-and-aggregate-reports"/>
        <set-payload value="Triggered report" doc:name="Set Payload"/>
    </flow>
    <flow name="Urbanspace:generate-daily-reports" processingStrategy="synchronous">
        <quartz:inbound-endpoint jobName="quartz-urbanspace-reports-1512017153" cronExpression="0 0 4 * * ? *" cronTimeZone="America/New_York" repeatInterval="0" connector-ref="Quartz-Urbanspace" responseTimeout="10000" doc:name="Run every day at 4:00am EST">
            <quartz:event-generator-job/>
        </quartz:inbound-endpoint>
        <logger message="Starting Urbanspace daily report generation for active deployments" level="INFO" doc:name="Logger"/>
        <component doc:name="Get all active deployments">
            <prototype-object class="urbanspace.DeploymentsCallable"/>
        </component>
        <foreach collection="#[payload]" counterVariableName="urbanspaceReportsCounter" rootMessageVariableName="urbanspaceReportsRootMessage" doc:name="For Each">
            <set-variable variableName="deployment" value="#[payload.getDeployment()]" doc:name="Deployment ID"/>
            <set-session-variable variableName="deploymentName" value="#[payload.getName()]" doc:name="Deployment Name"/>
            <set-session-variable variableName="range" value="#[payload.getRange()]" doc:name="Time range"/>
            <set-session-variable variableName="offset" value="#[payload.getOffset()]" doc:name="Time offset"/>
            <set-session-variable variableName="timeZone" value="#[payload.getTimeZone()]" doc:name="Timezone"/>
            <set-session-variable variableName="emails" value="#[payload.getEmails()]" doc:name="Emails"/>
            <set-property propertyName="MULE_CORRELATION_ID" value="#[java.util.UUID.randomUUID()] " doc:name="Set new correlation ID"/>
            <flow-ref name="Urbanspace:generate-individual-and-aggregate-reports" doc:name="Urbanspace:generate-individual-and-aggregate-reports"/>
        </foreach>
        <logger message="Finished running Urbanspace daily report generation for active deployments" level="INFO" doc:name="Logger"/>
    </flow>
</mule>
